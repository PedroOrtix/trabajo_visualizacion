---
title: "Notebook para Cardiología"
output: html_notebook
---

```{r}
# Cargar librerías necesarias
library(readxl)
library(dplyr)
library(ggplot2)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

```{r}
# Definir rutas base para los archivos
base_path <- "./data"
ruta_eventos <- file.path(base_path, "eventos.xlsx")
ruta_pacientes <- file.path(base_path, "pacientes.xlsx")

# Leer datos con selección de columnas específicas si es necesario
datos_eventos <- read_excel(ruta_eventos)
datos_pacientes <- read_excel(ruta_pacientes)
```

```{r}
glimpse(datos_eventos)
```

```{r}
glimpse(datos_pacientes)
```

```{r}
colnames(datos_eventos)
```

```{r}
colnames(datos_pacientes)
```

VISUALIZACION DE LA COHORTE DE LA GENTE

```{r}
# Cohorte de pacientes por género y edad
cohorte <- datos_pacientes %>%
  group_by(Sexo, Edad) %>%
  summarise(num_pacientes = n(), .groups = 'drop')
```

```{r}
# Diagrama de dispersión para cohorte de pacientes
ggplot(cohorte, aes(x = Edad, y = num_pacientes, color = Sexo)) +
  geom_point() +
  labs(x = "Edad", y = "Número de Pacientes", title = "Número de Pacientes por Género y Edad") +
  theme_minimal()
```

EVENTOS DE SANGRADO

```{r}
# Agrupar y contar eventos de sangrado por tipo
eventos_sangrado <- datos_eventos %>%
  group_by(`Tipo de sangrado`) %>%
  summarise(num_eventos = n(), .groups = 'drop')
```

```{r}
# Gráfico de barras para eventos de sangrado
ggplot(eventos_sangrado, aes(x = `Tipo de sangrado`, y = num_eventos, fill = `Tipo de sangrado`)) +
  geom_bar(stat = "identity") +
  labs(x = "Tipo de Sangrado", y = "Número de Eventos", title = "Eventos de Sangrado") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) # Mejora la legibilidad de las etiquetas
```

VISUALIZACIONES INTERACTIVAS PARTE 1

```{r}
library(shiny)
```

```{r}
print(names(datos_eventos))
print(names(datos_pacientes))
```

```{r}
eventos_con_edad <- datos_eventos %>%
  left_join(datos_pacientes %>% select(Paciente, Edad, Sexo), by = "Paciente")

```

```{r}
colnames(eventos_con_edad)
```

vamos a definir la UI de la parte 1.

```{r}
library(shiny)

# Definir la interfaz de usuario
ui <- fluidPage(
  titlePanel("Análisis Interactivo de Eventos en Pacientes"),
  sidebarLayout(
    sidebarPanel(
      selectInput("tipoEvento", "Tipo de Evento", choices = unique(eventos_con_edad$`Tipo de sangrado`)),
      selectInput("escalaGravedad", "Escala de Gravedad", choices = c("TIMI", "GUSTO", "BARC")),
      selectInput("gravedadEvento", "Gravedad del Evento", choices = NULL),  # Las opciones se actualizarán dinámicamente
      sliderInput("edad", "Edad", min = min(eventos_con_edad$Edad, na.rm = TRUE), 
                  max = max(eventos_con_edad$Edad, na.rm = TRUE), 
                  value = c(min(eventos_con_edad$Edad, na.rm = TRUE), max(eventos_con_edad$Edad, na.rm = TRUE))),
      selectInput("genero", "Género", choices = unique(datos_pacientes$Sexo))
    ),
    mainPanel(
      plotOutput("plotEventos", width = "100%")
    )
  )
)

server <- function(input, output, session) {
  # Actualizar dinámicamente las opciones de gravedad basadas en la escala seleccionada
  observe({
    escala <- switch(input$escalaGravedad,
                     "TIMI" = "Gravedad de la hemorragia (TIMI)",
                     "GUSTO" = "Gravedad de la hemorragia (GUSTO)",
                     "BARC" = "Gravedad de la hemorragia (BARC)")
    
    updateSelectInput(session, "gravedadEvento", 
                      choices = unique(eventos_con_edad[[escala]]))
  })

  # Renderizar el gráfico basado en los filtros aplicados
  output$plotEventos <- renderPlot({
    if (is.null(input$gravedadEvento)) {
      return()
    }

    datos_filtrados <- eventos_con_edad %>%
      filter(`Tipo de sangrado` == input$tipoEvento,
             get(paste0("Gravedad de la hemorragia (", input$escalaGravedad, ")")) == input$gravedadEvento,
             Edad >= input$edad[1], Edad <= input$edad[2],
             Sexo == input$genero)

    if (nrow(datos_filtrados) == 0) {
      return(NULL)
    }

    ggplot(datos_filtrados, aes(x = Edad, fill = `Tipo de sangrado`)) +
      geom_histogram(binwidth = 1) +
      labs(title = paste("Distribución de Eventos por Edad y Tipo usando escala", input$escalaGravedad),
           x = "Edad", y = "Frecuencia") +
      theme_minimal() +
      theme(plot.title = element_text(hjust = 0.5),
            axis.title.x = element_text(hjust = 0.5),
            axis.title.y = element_text(hjust = 0.5))
  })
}

# Correr la aplicación
shinyApp(ui = ui, server = server)
```

Paso 4: visualizaciones interactivas selección de datos.

```{r}
colnames(eventos_con_edad)
```

```{r}
ui <- fluidPage(
  titlePanel("Selección Interactiva en Diagrama de Dispersión"),
  sidebarLayout(
    sidebarPanel(
      helpText("Haga clic en los puntos en el gráfico para ver más detalles."),
      verbatimTextOutput("info_selected")
    ),
    mainPanel(
      plotOutput("scatterPlot", click = "plot_click", brush = "plot_brush", height = "500px")
    )
  )
)

server <- function(input, output) {
  output$scatterPlot <- renderPlot({
    ggplot(eventos_con_edad, aes(x = Edad, y = Sexo, color = Sexo)) +
      geom_point() +
      labs(
        x = "Edad",
        y = "Sexo",
        title = "Distribución de Pacientes por Edad y Sexo",
        color = "Sexo"
      ) +
      theme_minimal() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1))
  })
  
  output$info_selected <- renderText({
    brush <- input$plot_brush
    if (!is.null(brush)) {
      selected <- brushedPoints(eventos_con_edad, brush)
      if (nrow(selected) == 0) {
        "No hay puntos seleccionados"
      } else {
        # Usar lapply para aplicar una función a cada fila
        details <- lapply(1:nrow(selected), function(i) {
          paste(
            "Paciente:", selected[i, "Paciente"], "\n",
            "Sexo:", selected[i, "Sexo"], "\n",
            "Edad:", selected[i, "Edad"], "\n",
            "Tipo de sangrado:", selected[i, "Tipo de sangrado"], "\n",
            "Gravedad TIMI:", selected[i, "Gravedad de la hemorragia (TIMI)"], "\n",
            "Gravedad GUSTO:", selected[i, "Gravedad de la hemorragia (GUSTO)"], "\n",
            "Gravedad BARC:", selected[i, "Gravedad de la hemorragia (BARC)"], "\n",
            "Descenso hemoglobina:", selected[i, "Descenso de hemoglobina"], "\n",
            "Procedimientos terapéuticos", selected[i, "Procedimientos terapéuticos"], "\n"
          )
        })
        # Concatenar todos los detalles en un solo texto
        paste(unlist(details), collapse = "\n")
      }
    } else {
      "Haga clic y arrastre para seleccionar puntos en el gráfico."
    }
  })
}

shinyApp(ui = ui, server = server)
```
